# 碰牌操作修改说明

## 修改目标
让碰牌操作的逻辑与直杠操作保持一致，用户可以明确选择是碰了哪个玩家的牌。

## 修改内容

### 1. 操作流程统一
现在碰牌操作与直杠操作具有相同的操作流程：

1. **选择玩家**: 选择执行碰牌操作的玩家
2. **选择操作**: 选择"碰牌"操作
3. **选择被碰玩家**: 选择被碰牌的来源玩家（除了步骤1中选择的玩家）
4. **选择麻将牌**: 选择要碰的牌

### 2. 数据结构修改
- 碰牌的 `Meld` 对象现在包含 `source_player` 字段，记录被碰牌的来源玩家ID

### 3. 视觉显示增强
- 碰牌组的第3张牌右上角会显示来源玩家标识（"我"、"下"、"对"、"上"）
- 与直杠操作的第4张牌显示保持一致

### 4. 用户界面改进
- 步骤2.1的提示文字根据操作类型动态显示（"选择被杠玩家" 或 "选择被碰玩家"）
- 操作状态提示也会显示被碰玩家信息

## 修改的文件

1. **frontend/src/components/GameBoard.tsx**
   - 修改操作类型切换逻辑，碰牌也需要选择来源玩家
   - 修改碰牌的Meld创建逻辑，添加source_player字段
   - 修改UI显示逻辑，碰牌也显示步骤2.1
   - 修改状态提示，碰牌也显示来源玩家

2. **frontend/src/components/MahjongTable.tsx**
   - 在碰牌显示逻辑中添加来源指示器
   - 碰牌的第3张牌（索引为2）右上角显示来源玩家标识

## 使用示例

### 碰牌操作流程：
1. 选择"上家"
2. 选择"碰牌"操作 → 会显示步骤2.1
3. 在步骤2.1中选择被碰玩家，比如选择"下家"
4. 选择要碰的牌，比如"3万"
5. **结果**：
   - 上家的碰牌组中第3张"3万"右上角会显示"下"字
   - 上家的手牌自动减少2张"3万"（第3张来自下家）
   - 手牌总数从13张变为11张

### 对家碰牌流程（智能手牌管理）：
1. 选择"对家"
2. 选择"碰牌"操作 → 会显示步骤2.1
3. 选择被碰玩家，比如选择"上家"
4. 选择要碰的牌，比如"7万"
5. **结果**：
   - 系统自动确保对家有足够的7万（如果不足会自动补齐）
   - 对家的碰牌组中第3张"7万"右上角会显示"上"字
   - 对家的手牌自动减少3张"7万"
   - 手牌总数从13张变为10张
   - **无需提前添加手牌！**

### "我"碰牌流程（可见手牌，精确计算）：
1. 选择"我"
2. 选择"碰牌"操作 → 会显示步骤2.1
3. 选择被碰玩家，比如选择"对家"
4. 选择要碰的牌，比如"5筒"
5. **结果**：
   - "我"的碰牌组中第3张"5筒"右上角会显示"对"字
   - "我"的手牌自动减少2张"5筒"（第3张来自对家）
   - 手牌总数从13张变为11张

### 直杠操作流程（智能手牌管理）：
1. 选择"上家"
2. 选择"直杠"操作 → 会显示步骤2.1
3. 在步骤2.1中选择被杠玩家，比如选择"对家"
4. 选择要杠的牌，比如"5筒"
5. **结果**：
   - 系统自动确保上家有足够的5筒（如果不足会自动补齐）
   - 上家的直杠组中第4张"5筒"右上角会显示"对"字
   - 上家的手牌自动减少4张"5筒"
   - 手牌总数从13张变为9张
   - **无需提前添加手牌！**

### "我"直杠流程（可见手牌，精确计算）：
1. 选择"我"
2. 选择"直杠"操作 → 会显示步骤2.1
3. 选择被杠玩家，比如选择"上家"
4. 选择要杠的牌，比如"8万"
5. **结果**：
   - "我"的直杠组中第4张"8万"右上角会显示"上"字
   - "我"的手牌自动减少3张"8万"（第4张来自上家）
   - 手牌总数从13张变为10张

## 技术细节

- 复用了现有的 `SimpleSourceIndicator` 组件来显示来源玩家标识
- 保持了与直杠操作相同的UI交互模式
- 数据结构兼容，不影响现有功能

## 手牌自动减少功能

### 新增功能
在执行各种操作后，系统会自动从相应玩家的手牌中减少对应数量的牌：

### 碰牌操作
- **"我" 碰牌**: 自动从手牌中减少2张相同的牌（第3张是从别人那里碰来的）
- **其他玩家碰牌**: 自动从手牌中减少3张相同的牌（模拟真实场景，因为程序没有摸牌弃牌流程）

### 杠牌操作
- **暗杠**: 自动从手牌中减少4张相同的牌（所有玩家统一）
- **直杠**:
  - "我" 直杠：减少3张手牌（第4张是从别人那里杠来的）
  - 其他玩家直杠：减少4张手牌（模拟真实场景，无摸牌弃牌流程）
- **加杠**: 自动从手牌中减少1张相同的牌（在已有碰牌基础上加杠）

### 实现原理
- 在每种操作的meld创建后，立即调用 `removeTileFromHand()` 方法
- 根据操作类型和玩家身份确定需要减少的牌数
- **智能手牌管理**：对于其他玩家，如果手牌不足，自动添加所需牌（模拟真实场景）
- 确保游戏逻辑的完整性和准确性

### 设计说明

#### 为什么其他玩家碰牌减少3张手牌？为什么其他玩家直杠减少4张手牌？

1. **符合真实游戏场景**：
   - 对家、下家、上家的手牌对"我"是不可见的（显示为背面）
   - 在真实麻将中，只有当别人碰牌时，"我"才知道对方手上有相应的牌

2. **补偿程序设计简化**：
   - 本程序没有实现真实的摸牌、弃牌流程
   - 通过减少3张手牌来模拟真实的麻将牌数消耗

3. **游戏平衡性**：
   - "我"碰牌减少2张：因为我知道自己的手牌情况
   - 其他玩家碰牌减少3张：模拟真实场景的牌数消耗
   - "我"直杠减少3张：因为我知道自己的手牌情况  
   - 其他玩家直杠减少4张：模拟真实场景的牌数消耗

4. **用户体验**：
   - 避免了复杂的摸牌弃牌交互流程
   - 保持了游戏的真实感和平衡性

## 智能手牌管理

### 问题背景
在真实麻将中，其他玩家的手牌是不可见的。当其他玩家能够进行碰牌、杠牌操作时，说明他们手里肯定有相应的牌。

### 解决方案
程序采用**智能手牌管理**策略：

#### 对于"我"（playerId=0）
- 严格检查手牌，必须有足够的牌才能进行操作
- 符合真实游戏体验

#### 对于其他玩家
- **自动补齐逻辑**：如果手牌中没有足够的牌，自动添加所需数量的牌
- **然后正常扣除**：按照操作类型扣除相应数量的手牌
- **模拟真实场景**：假设其他玩家本来就有这些牌

### 实现示例

**对家碰7万的完整流程：**
1. 用户选择：对家 → 碰牌 → 上家 → 7万
2. 系统检查：对家手牌中有几张7万？
3. 自动补齐：如果少于3张，自动添加到3张
4. 执行碰牌：创建碰牌组，扣除3张7万
5. **结果**：对家成功碰牌，手牌数量正确减少

### 优势
- **无需预设手牌**：不需要提前给其他玩家添加特定手牌
- **符合真实逻辑**：其他玩家能碰牌就说明有相应的牌
- **简化操作流程**：用户可以直接进行碰牌杠牌操作
- **保持游戏平衡**：手牌数量变化完全正确

## 测试验证

### 🧪 简化测试步骤

现在您可以直接测试，无需预设手牌：

**测试1：对家碰7万**
1. 直接操作：对家 → 碰牌 → 上家 → 7万
2. **预期结果**：对家手牌从13张减少到10张，出现7万碰牌组

**测试2：下家直杠5筒**  
1. 直接操作：下家 → 直杠 → 对家 → 5筒
2. **预期结果**：下家手牌从13张减少到9张，出现5筒直杠组

**测试3：上家暗杠3万**
1. 直接操作：上家 → 暗杠 → 3万
2. **预期结果**：上家手牌从13张减少到9张，出现3万暗杠组

### ✅ 验证要点
- 无需预先添加任何手牌
- 手牌数量变化正确
- 碰杠组显示正确的来源标识
- "我"的操作仍需要足够的手牌 